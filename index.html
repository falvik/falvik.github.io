<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script src="https://gstatic.com/firebasejs/7.6.1/firebase.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<button type="button" id="subscribeBtn" hidden></button>
<script>
        //параметры из "Учетных данных для проекта" на вкладке "Cloud Messaging" настроек проекта Firebase
        const senderId = '493570643651';
        const apiKey = "AIzaSyBh8Xq1A02Hjh10rDgoUK3YfbKOyLsdJVg";
        const projectId = "test-51e78";
        const appId = "1:493570643651:web:cd564f697b8d081b17b476";

        const testClientCode = "121000011741609581";
        const host = "https://compath-callback.sportmaster.ru";
        const subscribeUrl = host + "/test/web-push-subscribe";
        const unsubscribeUrl = host + "/test/web-push-unsubscribe";

        // Initialize Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBh8Xq1A02Hjh10rDgoUK3YfbKOyLsdJVg",
            authDomain: "test-51e78.firebaseapp.com",
            databaseURL: "https://test-51e78.firebaseio.com",
            projectId: "test-51e78",
            storageBucket: "test-51e78.appspot.com",
            messagingSenderId: "493570643651",
            appId: "1:493570643651:web:cd564f697b8d081b17b476",
            measurementId: "G-LLFF9VTSRL"
        });
        var messaging = firebase.messaging();
        updateButtonState();

        function updateButtonState() {
            var button = document.getElementById("subscribeBtn");
            button.removeAttribute("hidden");
            switch (Notification.permission) {
                case "default":
                    button.setAttribute("onclick", "subscribe()");
                    button.innerText = "Подписаться";
                    break;
                case "granted":
                    messaging.getToken()
                        .then(token => {
                            if (checkToken(token)) {
                                button.setAttribute("onclick", "unsubscribe()");
                                button.innerText = "Отписаться";
                            } else {
                                button.setAttribute("onclick", "subscribe()");
                                button.innerText = "Подписаться (разрешение уже получено)";
                            }
                        });
                    break;
                case "denied":
                    button.disabled = true;
                    button.innerText = "Запрещено";
                    break;
            }
        }

        function subscribe() {
            //получаем ID устройства, при необходимости запрашивая разрешение у пользователя
            messaging.getToken()
                .then(function (currentToken) {
                    console.log("Пользователь согласился получать push. Токен пользователя:" + currentToken);
                    doSubscribe(currentToken);
                    saveToken(currentToken);
                    updateButtonState();
                })
                .catch(function (err) {
                    console.warn('Не удалось получить токен.' + err);
                    updateButtonState();
                });


        }

        function unsubscribe() {
            console.log("Отписываемся...");
            messaging.getToken()
                .then(token => messaging.deleteToken(token))
                .then(succesfull => {
                    if (succesfull) {
                        console.log("Токен успешно удалён");
                        //doUnsubscribe()
                    } else {
                        console.warn("Не удалось удалить токен");
                    }
                    updateButtonState()
                });
        }

        function checkToken(currentToken) {
            return window.localStorage.getItem('firebaseToken') === currentToken;
        }

        function saveToken(currentToken) {
            window.localStorage.setItem('firebaseToken', currentToken ? currentToken : '');
        }

        // отправка ID на сервер
        function doSubscribe(currentToken) {
            console.log('Отправка токена на сервер...');
            $.ajax(subscribeUrl, {
                type: 'POST',
                contentType: 'application/json',
                dataType: text,
                data: JSON.stringify({token: currentToken, clientCode: testClientCode}),
                success: function (data, status, xhr) {
                    console.log('Подписка отправлена: ' + status + ', data: ' + data);
                },
                error: function (jqXhr, textStatus, errorMessage) {
                    console.error('Подписка не отправлена' + errorMessage);
                }
            })
        }

        // отправка ID на сервер
        function doUnsubscribe(currentToken) {
            console.log('Отправка запроса на отписку от рассылки...');
            $.ajax({
                contentType: 'application/json',
                data: currentToken,
                type: 'POST',
                url: unsubscribeUrl
            }).done(function () {
                console.log('Информация об отписке отправлена');
            }).fail(function (err) {
                console.warn('Не удалось отправить информациб об отписке.', err);
            });
        }
</script>
</body>
</html>