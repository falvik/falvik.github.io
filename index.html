<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script src="https://gstatic.com/firebasejs/3.6.8/firebase.js"></script>
<script src="https://code.jquery.com/jquery-1.8.3.js"></script>
<button type="button" id="subscribeBtn" hidden></button>
<script>
    //"Идентификатор отправителя" из "Учетных данных для проекта" на вкладке "Cloud Messaging" настроек проекта Firebase
    const senderId = '493570643651';
    const testClientCode = 121000011741609581;
    const subscribeUrl = "https://compath-callback.sportmaster.ru/test/web-push-subscribe";

    firebase.initializeApp({
        messagingSenderId: senderId
    });
    var messaging = firebase.messaging();
    updateButtonState();

    function updateButtonState() {
        var button = document.getElementById("subscribeBtn");
        button.removeAttribute("hidden");
        switch (Notification.permission) {
            case "default":
                button.setAttribute("onclick", "subscribe()");
                button.innerText = "Подписаться";
                break;
            case "granted":
                button.setAttribute("onclick", "unsubscribe()");
                button.innerText = "Отписаться";
                break;
            case "denied":
                button.disabled = true;
                button.innerText = "Запрещено";
                break;
        }
    }

    function subscribe() {
        // запрашиваем разрешение на получение уведомлений
        messaging.requestPermission()
            .then(function () {
                updateButtonState();
                console.log("Пользователь согласился получать push");
                // получаем ID устройства
                messaging.getToken()
                    .then(function (currentToken) {
                        console.log("Токен пользователя:" + currentToken);
                        if (currentToken) {
                            sendTokenToServer(currentToken);
                        } else {
                            console.warn('Не удалось получить токен.');
                        }
                    })
                    .catch(function (err) {
                        console.warn('При получении токена произошла ошибка.', err);
                    });
            })
            .catch(function (err) {
                updateButtonState();
                console.warn('Не удалось получить разрешение на показ уведомлений.', err);
            });
    }

    function unsubscribe() {
        console.log("Отписываемся...")
        updateButtonState();
    }

    // отправка ID на сервер
    function sendTokenToServer(currentToken) {
        console.log('Отправка токена на сервер...');
        $.ajax({
            contentType: 'application/json',
            data: JSON.stringify({token: currentToken, clientCode: testClientCode}),
            type: 'POST',
            url: subscribeUrl
        }).then(function () {
            console.log('Токен успешно отправлен');
        }).catch(function (err) {
            console.warn('Не удалось отправить токен на сервер.', err);
        });
    }
</script>
</body>
</html>